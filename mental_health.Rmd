---
title: "kaggle_mental_health"
author: "WangYong"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
```

```{r}
data_path <- '../input/playground-series-s4e11/'
raw_train <- read_csv(file.path(data_path, 'train.csv'))
raw_test <- read_csv(file.path(data_path, 'test.csv'))
sample_submission <- read_csv(file.path(data_path,'sample_submission.csv'))
```


```{r}
skimr::skim(raw_train)
```
# Recipes
```{r}
prep_recipe <- recipe(Depression ~ ., data = raw_train) %>%
  step_rm(id) %>%
  step_mutate(Depression = factor(Depression),skip=TRUE) %>%
  step_mutate(
    across(where(is.character), as.factor)
  ) %>%
  step_unknown(all_nominal_predictors()) %>%
  # step_novel(all_nominal_predictors(),new_level ="unknown" ,skip = TRUE) %>%
  step_other(all_nominal_predictors, threshold =0.05) |>
  # step_other(Name, threshold = 0.01) %>%
  # step_other(Profession, threshold = 0.01) %>%
  # step_other(City, threshold = 0.01) %>%
  # step_other(Degree, threshold = 0.01) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_impute_median(all_numeric_predictors()) %>%
  step_normalize(all_numeric_predictors()) |>
  step_nzv(all_predictors())|>
  step_corr(all_predictors())|>
  check_missing(all_predictors())

prep_recipe|>prep()|>juice()
```



```{r}
# Model specification
lr_model <- logistic_reg() %>%
  set_engine("glm", family = "binomial") %>%
  set_mode("classification")


# Workflow
lr_workflow <- workflow() %>%
  add_recipe(prep_recipe) %>%
  add_model(lr_model)

# Train the model
lr_fit <- fit(lr_workflow, data = raw_train)
```

# performance
```{r}
lr_predictions <- predict(lr_fit, new_data = raw_train, type = "class")

results <- tibble(
  predicted = lr_predictions$.pred_class,
  actual = factor(raw_train$Depression)
)

accuracy(results, truth = actual, estimate = predicted)
```



```{r}
predictions <- predict(lr_fit, new_data = raw_test, type = "class")

submission <- tibble(
id = raw_test$id,
Depression = predictions$.pred_class
)

write_csv(submission, "submission.csv")
```

